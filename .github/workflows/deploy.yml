name: Deploy IAM Dashboard

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        # AWS_ROLE_ARN secret must be configured in Repository Settings ‚Üí Secrets
        # Format: arn:aws:iam::ACCOUNT_ID:role/IAMDash-Deployer-Prod
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Set deployment variables
      if: github.ref == 'refs/heads/main'
      id: deployment-vars
      run: |
        # Use hardcoded resource names - infrastructure is managed separately
        echo "lambda_function=iam-dashboard-scanner" >> $GITHUB_OUTPUT
        echo "s3_bucket=iam-dashboard-project" >> $GITHUB_OUTPUT
        echo "cloudfront_id=" >> $GITHUB_OUTPUT

    - name: Setup Node.js
      if: github.ref == 'refs/heads/main'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Python
      if: github.ref == 'refs/heads/main'
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Build and Deploy Frontend
      if: github.ref == 'refs/heads/main'
      run: |
        npm ci
        npm run build
        S3_BUCKET="${{ steps.deployment-vars.outputs.s3_bucket }}"
        if [ -z "$S3_BUCKET" ]; then
          echo "‚ö†Ô∏è  No S3 bucket found in Terraform outputs, using default pattern"
          S3_BUCKET="iam-dashboard-frontend-$(date +%s)"
        fi
        echo "üì§ Uploading build files to s3://$S3_BUCKET/"
        aws s3 sync build/ s3://$S3_BUCKET/ --delete
        CLOUDFRONT_ID="${{ steps.deployment-vars.outputs.cloudfront_id }}"
        if [ -n "$CLOUDFRONT_ID" ]; then
          echo "üîÑ Invalidating CloudFront cache for distribution $CLOUDFRONT_ID"
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_ID" \
            --paths "/*"
        else
          echo "‚ÑπÔ∏è  No CloudFront distribution found, skipping cache invalidation"
        fi

    - name: Deploy Lambda Function
      if: github.ref == 'refs/heads/main'
      run: |
        LAMBDA_FUNCTION_NAME="${{ steps.deployment-vars.outputs.lambda_function }}"
        if [ -z "$LAMBDA_FUNCTION_NAME" ]; then
          echo "‚ö†Ô∏è  No Lambda function name found in Terraform outputs, using default: iam-dashboard-scanner"
          LAMBDA_FUNCTION_NAME="iam-dashboard-scanner"
        fi
        echo "üì¶ Packaging Lambda function from infra/lambda/..."
        cd infra/lambda
        # Install dependencies if requirements.txt exists
        if [ -f requirements.txt ]; then
          echo "üì• Installing Python dependencies..."
          pip install -r requirements.txt -t . --quiet
        fi
        # Create deployment package
        zip -r lambda_function.zip . -x "*.git*" -x "__pycache__/*" -x "*.pyc" -x "*.zip" -x "terraform.tfstate*" -x "*.tf" -x "*.md" -x "test-event.json" -x "tfplan"
        echo "üöÄ Updating Lambda function $LAMBDA_FUNCTION_NAME"
        aws lambda update-function-code \
          --function-name "$LAMBDA_FUNCTION_NAME" \
          --zip-file fileb://lambda_function.zip
        echo "‚úÖ Lambda function deployed successfully"

